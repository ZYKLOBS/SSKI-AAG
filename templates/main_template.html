<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SSKI AAG</title>
  <link rel="icon" href="/static/Logo_SSKI.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    .modal-backdrop {
      transition: none !important;
    }
  </style>
</head>
<body>

{% if error_message %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  {{ error_message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div id="main_content" class="container-fluid">
  <form id="save-form"
        hx-post="/save-project-button/"
        hx-trigger="click from:#save-button"
        hx-include="#save-form"
        hx-target="this"
        hx-swap="none">

       <div class="row g-3 align-items-center mb-4 mt-4">
          <!-- Project Select -->
          <div class="col-auto align-self-center">
            <label for="projectSelect" class="form-label visually-hidden">Project</label>
            <select id="projectSelect" class="form-select" name="project_id"
                    hx-post="/load-project/"
                    hx-trigger="change"
                    hx-target="#main_content"
                    hx-swap="outerHTML">
              {% for p in projects %}
              <option value="{{ p.id }}" {% if p.id == project.id %} selected {% endif %}>{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- New Project Input + Create -->
          <div class="col-auto align-self-center">
            <input type="text" id="project-create-name" name="name" class="form-control" placeholder="New project name">
          </div>
          <div class="col-auto align-self-center">
            <button type="button" class="btn btn-primary"
                    hx-post="/projects-create-button/"
                    hx-trigger="click"
                    hx-include="[name='name']"
                    hx-target="#main_content"
                    hx-swap="outerHTML">
              Create
            </button>
          </div>

          <!-- Rename Input + Rename -->
          <div class="col-auto align-self-center">
            <input type="text" id="project-rename" name="rename" class="form-control" placeholder="Rename to...">
          </div>
          <div class="col-auto align-self-center">
            <button type="button" class="btn btn-primary"
                    hx-post="/projects-rename-button/"
                    hx-trigger="click"
                    hx-include="[name='rename']"
                    hx-target="#main_content"
                    hx-swap="outerHTML">
              Rename
            </button>
          </div>

          <!-- Delete -->
          <div class="col-auto align-self-center">
            <button type="button" class="btn btn-danger"
                    hx-post="/projects-delete-button/"
                    hx-trigger="click"
                    hx-confirm="Are you sure you want to delete this project?">
              Delete
            </button>
          </div>

          <!-- Import -->
          <div class="col-auto align-self-center">
            <input id="file-upload" type="file" name="file" accept=".xls,.xlsx" style="display: none;"
                   hx-post="/upload_excel"
                   hx-trigger="change"
                   hx-target="#main_content"
                   hx-swap="outerHTML"
                   hx-encoding="multipart/form-data" />
            <label for="file-upload" class="btn btn-primary">Import</label>
          </div>

          <!-- Export -->
          <div class="col-auto align-self-center">
            <a href="/export_excel" class="btn btn-info" role="button" download>Export</a>
          </div>

          <!-- Save -->
          <div class="col-auto align-self-center">
            <button id="save-button" type="button" class="btn btn-success">Save</button>
          </div>

           <div class="col-auto align-self-right" > Model </div>
          <!-- Model Select -->
          <div class="col-auto align-self-center">
            <label for="modelSelect" class="form-label visually-hidden">Model</label>
            <select id="modelSelect" name="model" class="form-select"
                    hx-get="/models-options/"
                    hx-trigger="load"
                    hx-target="#modelSelect"
                    hx-swap="innerHTML"
                    hx-include="[name='project_id']">
              <option selected disabled>Loading...</option>
            </select>
          </div>

           <div class="col-auto align-self-right" > API-Key </div>
          <!-- API Key -->
          <div class="col-auto align-self-center">
              <input type="password" id="api-key" name="api_key" class="form-control" placeholder="API Key"
                   value="{{ project.api_key if project else '' }}">
          </div>
        </div>


{% if project %}
  <!-- Textareas -->
  <div class="row mb-4">
    <div class="col-6">
      <label for="source_text" class="form-label">Source Text</label>
      <textarea class="form-control" id="source_text" name="source_text" rows="5">{{ project.source_text }}</textarea>
    </div>
    <div class="col-6">
      <label for="prompt_template" class="form-label">Prompt Template</label>
      <textarea class="form-control" id="prompt_template" name="prompt_template" rows="5">{{ project.prompt_template }}</textarea>
    </div>
  </div>

  <!-- Questions Section -->
  <div id="questions-container">
    {% for question in project.questions %}
    <div class="row mb-4 question-block" id="question-{{ question.id }}">
      <div class="col-6">
        <label class="form-label" for="source-{{ question.id }}">Question</label>
        <textarea class="form-control" name="questions[{{ loop.index0 }}][question]" id="source-{{ question.id }}" rows="5">{{ question.question }}</textarea>
        <input type="hidden" name="questions[{{ loop.index0 }}][id]" value="{{ question.id }}">
        <input type="hidden" name="questions[{{ loop.index0 }}][project_id]" value="{{ question.project_id }}">
      </div>
      <div class="col-6">
        <label class="form-label" for="answer-{{ question.id }}">Answer</label>
        <textarea class="form-control" name="questions[{{ loop.index0 }}][answer]" id="answer-{{ question.id }}" rows="5"
                  oninput="updateWordCount({{ question.id }})">{{ question.answer }}</textarea>
        <small class="form-text text-muted">Word Count: <span id="word-count-{{ question.id }}">0</span></small>

        <div class="mt-2">
          <button type="button" class="btn btn-outline-danger btn-sm"
                  hx-post="/delete_question/{{ question.id }}?project_id={{ question.project_id }}"
                  hx-target="#main_content"
                  hx-swap="outerHTML"
                  hx-confirm="Are you sure you want to delete this question?">
            Delete
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm"
                  hx-post="/regenerate_answer/{{ question.id }}?project_id={{ question.project_id }}"
                  hx-target="#main_content"
                  hx-swap="outerHTML"
                  hx-confirm="Are you sure you want to regenerate the answer?">
            + Regenerate
          </button>
        </div>

        <div class="input-group input-group-sm mt-2">
          <input type="text" class="form-control" name="refine_prompt" id="refine_prompt_{{ question.id }}"
                 placeholder="Additional instructions to refine the answer">
          <button type="button"
          class="btn btn-outline-primary"
          hx-post="/refine_answer/{{ question.id }}?project_id={{ question.project_id }}"
          hx-target="#main_content"
          hx-swap="outerHTML"
          hx-confirm="Are you sure you want to refine the answer?">
            ðŸ”§ Refine
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Add Question / Generate -->
  <div class="d-flex justify-content-center mb-5">
    <button type="button" class="btn btn-success btn-lg" onclick="addQuestion()">+</button>
    <input type="hidden" id="question-index" value="{{ project.questions|length }}">
    <button id="generate-answers-button" type="button" class="btn btn-primary ms-3"
            hx-post="/generate-answers/"
            hx-trigger="click"
            hx-target="#main_content"
            hx-include="#save-form"
            hx-swap="outerHTML">
      Generate Answers
    </button>
  </div>
{% else %}
  <div class="alert alert-warning mt-4" role="alert">
    <strong>No project selected.</strong> Please create or select a project before editing.
  </div>
{% endif %}

</form>
</div>

<!-- Loading Modal -->
<div class="modal" tabindex="-1" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div><strong>Generating answers, please wait...</strong></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@2.0.4" crossorigin="anonymous"></script>

<script>
  if (!window.saveAlertListenerAdded) {
    document.body.addEventListener('htmx:afterRequest', function(event) {
      if (event.target.id === 'save-button') {
        alert('Saved successfully');
      }
    });
    window.saveAlertListenerAdded = true;
  }

  function addQuestion() {
    const indexEl = document.getElementById("question-index");
    const currentIndex = parseInt(indexEl.value);
    const projectId = document.getElementById("projectSelect").value;

    htmx.ajax('GET', `/add_question?index=${currentIndex}&project_id=${projectId}`, {
      target: '#questions-container',
      swap: 'beforeend'
    });

    indexEl.value = currentIndex + 1;
  }

  function refineWithPrompt(questionId, projectId) {
    const input = document.getElementById(`refine_prompt_${questionId}`);
    const prompt = encodeURIComponent(input.value);

    htmx.ajax('POST', `/refine_answer/${questionId}?project_id=${projectId}&refine_prompt=${prompt}`, {
      target: '#main_content',
      swap: 'outerHTML',
      headers: {
        'HX-Confirm': 'Are you sure you want to refine the answer? This will regenerate the answer.'
      }
    });
  }

  function updateWordCount(questionId) {
    const textarea = document.getElementById(`answer-${questionId}`);
    const wordCountEl = document.getElementById(`word-count-${questionId}`);
    const text = textarea.value.trim();
    const words = text.split(/\s+/).filter(w => w.length > 0);
    wordCountEl.textContent = words.length;
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("textarea[id^='answer-']").forEach(textarea => {
      const id = textarea.id.split("-")[1];
      updateWordCount(id);
    });
  });

  document.addEventListener("htmx:afterSwap", () => {
    document.querySelectorAll("textarea[id^='answer-']").forEach(textarea => {
      const id = textarea.id.split("-")[1];
      updateWordCount(id);
    });
  });

  let loadingModal = null;
  document.body.addEventListener('htmx:beforeRequest', (evt) => {
    if (evt.detail.elt && evt.detail.elt.id === 'generate-answers-button') {
      const modalEl = document.getElementById('loadingModal');
      if (modalEl) {
        loadingModal = new bootstrap.Modal(modalEl);
        loadingModal.show();
      }
    }
  });

  document.body.addEventListener('htmx:afterRequest', () => {
    if (loadingModal) {
      loadingModal.hide();
      loadingModal._element.addEventListener('hidden.bs.modal', () => {
        loadingModal.dispose();
        loadingModal = null;
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
      }, { once: true });
    }
  });
</script>

</body>
</html>
